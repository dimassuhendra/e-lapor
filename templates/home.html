{% extends "layout.html" %} {% block title %}Dashboard Publik Lapor!{% endblock %} {% block content %}
<div class="section" id="hero">
     <div class="container py-5 text-center">
          <h1 class="display-6 fw-bold text-white mb-3">Suara Anda, Perubahan Kota Kami</h1>
          <p class="lead text-white-50">Platform resmi Lapor! Pemerintah Kota Bandar Lampung. Laporkan berbagai isu mulai dari infrastruktur, layanan publik, hingga lingkungan, dan pantau langsung perkembangannya.</p>
          <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4">
               <a href="{{ url_for('lapor') }}" class="btn btn-warning btn-lg px-4 gap-3 fw-bold laporan"> <i class="bi bi-chat-left-text-fill me-2"></i>Buat Laporan </a>
               <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-lg px-4"> <i class="bi bi-list-ul me-2"></i>Lihat Semua Laporan </a>
          </div>
     </div>

     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
          <path
               fill="#fff"
               fill-opacity="1"
               d="M0,128L34.3,154.7C68.6,181,137,235,206,234.7C274.3,235,343,181,411,176C480,171,549,213,617,234.7C685.7,256,754,256,823,224C891.4,192,960,128,1029,128C1097.1,128,1166,192,1234,218.7C1302.9,245,1371,235,1406,229.3L1440,224L1440,320L1405.7,320C1371.4,320,1303,320,1234,320C1165.7,320,1097,320,1029,320C960,320,891,320,823,320C754.3,320,686,320,617,320C548.6,320,480,320,411,320C342.9,320,274,320,206,320C137.1,320,69,320,34,320L0,320Z"
          ></path>
     </svg>
</div>

<div class="section d-flex align-items-center" id="peta">
     <div class="container-md text-center">
          <div class="row p-4 justify-content-around align-items-center">
               <div class="col-3 update">
                    <h4 class="display-5 fw-bold text-black">Laporan Terbaru</h4>
               </div>

               <div class="col-6">
                    <div id="laporanCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel">
                         <!-- <ol class="carousel-indicators">
                              {% for laporan in paginated_laporan_list %} {% if loop.index0 < 10 %}
                              <li
                                   data-bs-target="#laporanCarousel"
                                   data-bs-slide-to="{{ loop.index0 }}"
                                   class="{% if loop.first %}active{% endif %}"
                                   aria-current="{% if loop.first %}true{% else %}false{% endif %}"
                                   aria-label="Slide {{ loop.index }}"
                              ></li>
                              {% endif %} {% endfor %}
                         </ol> -->

                         <div class="carousel-inner" role="listbox">
                              {% for laporan in paginated_laporan_list %} {% if loop.index0 < 10 %}
                              <div class="carousel-item {% if loop.first %}active{% endif %}">
                                   <a href="{{ url_for('detail_laporan', laporan_id=laporan.id) }}" class="card text-decoration-none h-100">
                                        <div class="card-body p-5">
                                             <h5 class="card-title">{{ laporan.judul }}</h5>
                                             <h6 class="card-subtitle mb-2 text-muted">Pelapor: {{ laporan.nama_pelapor }}</h6>

                                             <p class="card-text">{{ laporan.deskripsi }}</p>

                                             <div class="d-flex justify-content-between align-items-center mt-3">
                                                  <span
                                                       class="badge {% if laporan.status == 'Diterima' %} bg-warning text-dark {% elif laporan.status == 'Diproses' %} bg-info text-dark {% elif laporan.status == 'Selesai' %} bg-success {% else %} bg-secondary {% endif %} rounded-pill"
                                                  >
                                                       {{ laporan.status }}
                                                  </span>
                                                  <small class="text-muted">{{ laporan.timestamp.split(' ')[0] }}</small>
                                             </div>
                                        </div>
                                   </a>
                              </div>
                              {% endif %} {% else %}
                              <div class="carousel-item active">
                                   <div class="d-flex align-items-center justify-content-center h-100">
                                        <p class="text-muted">Belum ada laporan.</p>
                                   </div>
                              </div>
                              {% endfor %}
                         </div>

                         <button class="carousel-control-prev" type="button" data-bs-target="#laporanCarousel" data-bs-slide="prev">
                              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Previous</span>
                         </button>
                         <button class="carousel-control-next" type="button" data-bs-target="#laporanCarousel" data-bs-slide="next">
                              <span class="carousel-control-next-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Next</span>
                         </button>
                    </div>
               </div>
          </div>
     </div>
</div>

<div class="section">
     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
          <path
               fill="#fff"
               fill-opacity="1"
               d="M0,160L34.3,165.3C68.6,171,137,181,206,186.7C274.3,192,343,192,411,181.3C480,171,549,149,617,138.7C685.7,128,754,128,823,160C891.4,192,960,256,1029,245.3C1097.1,235,1166,149,1234,138.7C1302.9,128,1371,192,1406,224L1440,256L1440,0L1405.7,0C1371.4,0,1303,0,1234,0C1165.7,0,1097,0,1029,0C960,0,891,0,823,0C754.3,0,686,0,617,0C548.6,0,480,0,411,0C342.9,0,274,0,206,0C137.1,0,69,0,34,0L0,0Z"
          ></path>
     </svg>
</div>
<div class="row g-4">
     <div class="col-lg-3 bg-pr">
          <h4 class="mb-3"><i class="bi bi-list-ul me-2"></i>Laporan Terbaru</h4>
          <div class="list-group shadow-sm listlaporan">
               {% for laporan in paginated_laporan_list %}
               <a href="{{ url_for('detail_laporan', laporan_id=laporan.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto">
                         <div class="fw-bold">{{ laporan.judul }}</div>
                         <small class="text-muted"><i class="bi bi-clock me-1"></i>{{ laporan.timestamp.split(' ')[0] }}</small>
                    </div>
                    <span
                         class="badge {% if laporan.status == 'Diterima' %}text-bg-warning {% elif laporan.status == 'Diproses' %}text-bg-primary {% elif laporan.status == 'Selesai' %}text-bg-success {% else %}text-bg-secondary {% endif %} rounded-pill"
                         style="font-size: 0.75rem"
                         >{{ laporan.status }}</span
                    >
               </a>
               {% else %}
               <div class="list-group-item text-center text-muted">Belum ada laporan.</div>
               {% endfor %}
          </div>

          {% if laporan_pagination.total_pages > 1 %}
          <nav class="mt-3">
               <ul class="pagination pagination-sm justify-content-center">
                    <li class="page-item {% if laporan_pagination.page == 1 %}disabled{% endif %}">
                         <a class="page-link" href="{{ url_for('index', laporan_page=laporan_pagination.page - 1, pengumuman_page=pengumuman_pagination.page) }}">&laquo;</a>
                    </li>
                    <li class="page-item active">
                         <span class="page-link">{{ laporan_pagination.page }} dari {{ laporan_pagination.total_pages }}</span>
                    </li>
                    <li class="page-item {% if laporan_pagination.page == laporan_pagination.total_pages %}disabled{% endif %}">
                         <a class="page-link" href="{{ url_for('index', laporan_page=laporan_pagination.page + 1, pengumuman_page=pengumuman_pagination.page) }}">&raquo;</a>
                    </li>
               </ul>
          </nav>
          {% endif %}
     </div>

     <div class="col-lg-6">
          <div class="card shadow-sm">
               <div class="card-header bg-white border-0 pt-3">
                    <div class="d-flex justify-content-between align-items-center">
                         <h5 class="mb-0 fw-bold"><i class="bi bi-map-fill me-2 text-primary"></i>Peta Sebaran Laporan</h5>
                         <div class="btn-group btn-group-sm" role="group">
                              <input type="radio" class="btn-check" name="map_filter" id="filter_semua" value="semua" checked />
                              <label class="btn btn-outline-primary" for="filter_semua">Semua</label>

                              <input type="radio" class="btn-check" name="map_filter" id="filter_berjalan" value="berjalan" />
                              <label class="btn btn-outline-primary" for="filter_berjalan">Berjalan</label>

                              <input type="radio" class="btn-check" name="map_filter" id="filter_selesai" value="selesai" />
                              <label class="btn btn-outline-primary" for="filter_selesai">Selesai</label>
                         </div>
                    </div>
               </div>
               <div class="card-body p-0">
                    <div id="map" style="height: 520px; border-radius: 0 0 0.375rem 0.375rem"></div>
               </div>
          </div>
     </div>

     <div class="col-lg-3">
          <h4 class="mb-3"><i class="bi bi-megaphone me-2"></i>Pengumuman</h4>
          <div class="list-group shadow-sm">
               {% for p in paginated_pengumuman_list %}
               <a href="{{ url_for('detail_laporan', laporan_id=p.id) }}" class="list-group-item list-group-item-action">
                    <div class="fw-bold">Re: {{ p.judul }}</div>
                    <p class="mb-1 small text-muted">"{{ p.pengumuman_publik|truncate(80) }}"</p>
                    <small class="text-muted"><i class="bi bi-calendar-check me-1"></i>{{ p.timestamp.split(' ')[0] }}</small>
               </a>
               {% else %}
               <div class="list-group-item text-center text-muted">Belum ada pengumuman.</div>
               {% endfor %}
          </div>

          {% if pengumuman_pagination.total_pages > 1 %}
          <nav class="mt-3">
               <ul class="pagination pagination-sm justify-content-center">
                    <li class="page-item {% if pengumuman_pagination.page == 1 %}disabled{% endif %}">
                         <a class="page-link" href="{{ url_for('index', laporan_page=laporan_pagination.page, pengumuman_page=pengumuman_pagination.page - 1) }}">&laquo;</a>
                    </li>
                    <li class="page-item active">
                         <span class="page-link">{{ pengumuman_pagination.page }} dari {{ pengumuman_pagination.total_pages }}</span>
                    </li>
                    <li class="page-item {% if pengumuman_pagination.page == pengumuman_pagination.total_pages %}disabled{% endif %}">
                         <a class="page-link" href="{{ url_for('index', laporan_page=laporan_pagination.page, pengumuman_page=pengumuman_pagination.page + 1) }}">&raquo;</a>
                    </li>
               </ul>
          </nav>
          {% endif %}
     </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
     document.addEventListener('DOMContentLoaded', function () {
         var map = L.map('map').setView([-5.42, 105.26], 13);
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             maxZoom: 19,
             attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
         }).addTo(map);

         const allLaporanData = {{ all_laporan_list | tojson | safe }};
         let markers = L.layerGroup().addTo(map);

         // Definisi warna yang konsisten dengan badge status
         const statusColors = {
             'Diterima': '#ffc107', // Kuning
             'Diproses': '#0d6efd', // Biru
             'Selesai': '#198754'   // Hijau
         };

         function createCustomIcon(status) {
             const color = statusColors[status] || '#6c757d'; // Default color abu-abu
             return L.divIcon({
                 html: `<div style="width: 24px; height: 24px; background-color: ${color}; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.4); border: 2px solid white;"><i class="bi bi-geo-alt-fill" style="color: white; font-size: 12px;"></i></div>`,
                 className: 'custom-map-icon',
                 iconSize: [24, 24],
                 iconAnchor: [12, 24],
                 popupAnchor: [0, -24]
             });
         }

         function updateMap(filter) {
             markers.clearLayers();
             allLaporanData.forEach(function(laporan) {
                 let show = false;
                 if (filter === 'semua') {
                     show = true;
                 } else if (filter === 'selesai' && laporan.status === 'Selesai') {
                     show = true;
                 } else if (filter === 'berjalan' && (laporan.status === 'Diterima' || laporan.status === 'Diproses')) {
                     show = true;
                 }

                 if (show && laporan.latitude && laporan.longitude) {
                     var marker = L.marker([laporan.latitude, laporan.longitude], {
                         icon: createCustomIcon(laporan.status)
                     });
                     marker.bindPopup(`<b>${laporan.judul}</b><br>Status: ${laporan.status}<br><a href="/laporan/${laporan.id}">Lihat Detail</a>`);
                     markers.addLayer(marker);
                 }
             });
         }

         document.querySelectorAll('input[name="map_filter"]').forEach(radio => {
             radio.addEventListener('change', function() {
                 updateMap(this.value);
             });
         });

         // Initial map load
         updateMap('semua');
     });
</script>
{% endblock %}

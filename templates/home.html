{% extends "layout.html" %} {% block title %}Dashboard Publik Lapor!{% endblock %} {% block content %}
<style>
     /* SKEMA WARNA BIRU MUDA KONSISTEN */
     :root {
          --primary-light: #f0f8ff; /* Background Terang */
          --secondary-blue: #1e88e5; /* Biru Cerah (Judul Section, Aksen) */
          --accent-green: #00897b; /* Hijau Teal (Tombol) */
          --dark-text: #343a40; /* Teks Utama Gelap */
          --sub-text: #6c757d; /* Abu-abu untuk sub-teks */
          --card-bg: #ffffff; /* Card Background Putih */
     }

     /* 1. Pengaturan Warna Latar Belakang Global (Menggunakan variabel layout) */
     body {
          background-color: var(--primary-light) !important;
          color: var(--dark-text);
     }

     /* 2. Style untuk Section Hero */
     #hero {
          background-color: var(--secondary-blue); /* Biru Cerah sebagai latar hero */
          min-height: 40vh;
          padding-top: 5rem;
          padding-bottom: 5rem;
     }

     /* 3. Style untuk Judul dan Teks di Hero */
     #hero h1 {
          color: var(--primary-light) !important; /* Judul Putih */
          font-weight: 700 !important;
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
     }
     #hero p.lead {
          color: #e0e0e0 !important; /* Teks sedikit abu-abu terang */
     }

     /* 4. Style untuk Tombol Utama (Aksen Hijau Teal) */
     .btn-lapor-accent {
          background-color: var(--accent-green) !important;
          border-color: var(--accent-green) !important;
          color: #ffffff !important;
          font-weight: bold !important;
          transition: all 0.3s;
          box-shadow: 0 5px 15px rgba(0, 137, 123, 0.3);
     }
     .btn-lapor-accent:hover {
          background-color: #00a896 !important;
          border-color: #00a896 !important;
          box-shadow: 0 5px 20px rgba(0, 137, 123, 0.5);
     }

     /* 5. Style untuk Bagian Laporan dan Pengumuman */
     .section {
          padding-top: 3rem;
          padding-bottom: 3rem;
          background-color: var(--primary-light) !important;
          color: var(--dark-text);
     }
     #laporanTerbaru h4,
     #pengumuman h4,
     #petaLaporan h4 {
          color: var(--secondary-blue) !important; /* Judul section berwarna Biru Cerah */
          border-bottom: 2px solid var(--secondary-blue);
          display: inline-block;
          padding-bottom: 5px;
     }
     /* Mengubah teks 'muted' agar terlihat baik di background terang */
     .text-muted {
          color: var(--sub-text) !important;
     }

     /* 6. Style untuk Card Laporan/Pengumuman (Disesuaikan untuk Light Mode) */
     .card.laporan-card,
     .card.pengumuman-card {
          background-color: var(--card-bg);
          color: var(--dark-text);
          transition: transform 0.2s, box-shadow 0.2s;
          border: 1px solid #dee2e6;
          border-radius: 0.75rem;
     }
     .card.laporan-card:hover,
     .card.pengumuman-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
     }
     .card-title.text-dark {
          color: var(--secondary-blue) !important;
     }
     .card-subtitle.text-muted {
          color: var(--sub-text) !important;
     }
     .card-body a {
          color: var(--secondary-blue);
     }

     /* 6.1: Placeholder "Tidak ada Foto" */
     .card-img-top + .card-body .text-muted.small {
          color: var(--sub-text) !important;
     }
     .card-img-top + .card-body {
          background-color: var(--card-bg);
     }
     .card-img-top[style*="background-color: var(--primary-dark)"] {
          background-color: #e9ecef !important; /* Ubah warna placeholder gelap menjadi abu terang */
     }

     /* 7. Style untuk MAP Section */
     #map {
          height: 500px;
          border-radius: 0.5rem;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
          margin-bottom: 2rem;
          z-index: 1; /* Penting agar map tetap di atas elemen lain */
     }
     .map-filter {
          background-color: var(--card-bg);
          border: 1px solid #dee2e6;
          padding: 0.5rem;
          border-radius: 0.5rem;
          margin-bottom: 1rem;
          display: inline-flex;
     }
     .map-filter .form-check-label {
          color: var(--dark-text);
     }
     .map-filter .form-check-input:checked + .form-check-label {
          color: var(--secondary-blue);
          font-weight: 600;
     }
     .text-truncate-3 {
          display: -webkit-box;
          -webkit-line-clamp: 3;
          -webkit-box-orient: vertical;
          overflow: hidden;
          text-overflow: ellipsis;
     }
</style>

<div class="section d-flex justify-content-center" id="hero">
     <div class="container text-center">
          <h1 class="display-6 fw-bold">Suara Anda, Perubahan Kota Kami</h1>
          <p class="lead text-white-50">Platform resmi Lapor! Pemerintah Kota Bandar Lampung. Laporkan berbagai isu mulai dari infrastruktur, layanan publik, hingga lingkungan, dan pantau langsung perkembangannya.</p>
          <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4">
               <a href="{{ url_for('lapor') }}" class="btn btn-submit-elegant btn-lg px-4 gap-3"> <i class="bi bi-chat-left-text-fill me-2"></i>Buat Laporan </a>
          </div>
     </div>
</div>

<div class="section" id="laporanTerbaru">
     <div class="container-md text-center">
          <div class="row p-3 p-md-4 justify-content-around align-items-center">
               <div class="col-12 text-center mb-4 mb-md-5">
                    <div class="title-laporan mb-5"></div>
                    <h4 class="display-6 fw-bold">Laporan Terbaru</h4>
                    <p class="text-muted">Lihat laporan terbaru yang sudah masuk, dilengkapi foto bukti.</p>
               </div>

               <div class="col-12">
                    <div id="laporanCarousel" class="carousel slide bg-transparent" data-bs-ride="carousel">
                         <div class="carousel-inner p-1 p-md-3" role="listbox">
                              {% set chunk_size = 4 %} {% set chunks = (paginated_laporan_list | batch(chunk_size)) %} {% for chunk in chunks %}
                              <div class="carousel-item {% if loop.first %}active{% endif %}">
                                   <div class="row g-4">
                                        {% for laporan in chunk %}
                                        <div class="col-12 col-sm-6 col-lg-3">
                                             <a href="{{ url_for('detail_laporan', laporan_id=laporan.id) }}" class="card laporan-card shadow-sm h-100 text-decoration-none transition-hover">
                                                  {% if laporan.foto %}
                                                  <img src="{{ url_for('static', filename='uploads/' + laporan.foto) }}" class="card-img-top object-fit-cover" alt="{{ laporan.judul }}" style="height: 180px" />
                                                  {% else %}
                                                  <div class="card-img-top d-flex flex-column align-items-center justify-content-center text-muted p-4" style="height: 180px; background-color: #e9ecef">
                                                       <i class="bi bi-image-fill fs-3 mb-2" style="color: var(--sub-text)"></i>
                                                       <small style="color: var(--sub-text)">Tidak ada Foto</small>
                                                  </div>
                                                  {% endif %}
                                                  <div class="card-body d-flex flex-column">
                                                       <h5 class="card-title fw-bold text-truncate text-dark">{{ laporan.judul }}</h5>
                                                       <h6 class="card-subtitle mb-2 text-muted small">Pelapor: {{ laporan.nama_pelapor }}</h6>
                                                       <p class="card-text text-sm flex-grow-1 text-muted text-truncate-3">{{ laporan.deskripsi }}</p>

                                                       <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top" style="border-color: #dee2e6 !important">
                                                            <span
                                                                 class="badge {% if laporan.status == 'Diterima' %}bg-warning text-dark{% elif laporan.status == 'Diproses' %}bg-info text-dark{% elif laporan.status == 'Selesai' %}bg-success{% else %}bg-secondary{% endif %} rounded-pill fw-semibold"
                                                            >
                                                                 {{ laporan.status }}
                                                            </span>
                                                            <small class="text-muted"><i class="bi bi-clock me-1"></i> {{ laporan.timestamp.split(' ')[0] }}</small>
                                                       </div>
                                                  </div>
                                             </a>
                                        </div>
                                        {% endfor %}
                                   </div>
                              </div>
                              {% endfor %} {% if not paginated_laporan_list %}
                              <div class="carousel-item active">
                                   <div class="d-flex align-items-center justify-content-center py-5">
                                        <p class="text-muted">Belum ada laporan.</p>
                                   </div>
                              </div>
                              {% endif %}
                         </div>

                         <button class="carousel-control-prev" type="button" data-bs-target="#laporanCarousel" data-bs-slide="prev">
                              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Previous</span>
                         </button>
                         <button class="carousel-control-next" type="button" data-bs-target="#laporanCarousel" data-bs-slide="next">
                              <span class="carousel-control-next-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Next</span>
                         </button>
                    </div>
               </div>
          </div>
     </div>
</div>

<div class="section" id="pengumuman">
     <div class="container-md text-center">
          <div class="row p-3 p-md-4 justify-content-around align-items-center">
               <div class="col-12 text-center mb-4 mb-md-5">
                    <h4 class="display-6 fw-bold">Pengumuman</h4>
                    <p class="text-muted">Berikut beberapa informasi yang dapat kami sampaikan</p>
               </div>

               <div class="col-12">
                    <div id="pengumumanCarousel" class="carousel slide" data-bs-ride="carousel">
                         <div class="carousel-inner p-1 p-md-3" role="listbox">
                              {% set chunk_size = 4 %} {% set chunks = (paginated_pengumuman_list | batch(chunk_size)) %} {% for chunk in chunks %}
                              <div class="carousel-item {% if loop.first %}active{% endif %}">
                                   <div class="row g-4">
                                        {% for pengumuman in chunk %}
                                        <div class="col-12 col-sm-6 col-lg-3">
                                             <a href="{{ url_for('detail_laporan', laporan_id=pengumuman.id) }}" class="card pengumuman-card shadow-sm h-100 text-decoration-none transition-hover">
                                                  <div class="card-body d-flex flex-column">
                                                       <h5 class="card-title fw-bold text-truncate text-dark">Re: {{ pengumuman.judul }}</h5>

                                                       <p class="card-text flex-grow-1 text-muted text-truncate-3">{{ pengumuman.pengumuman_publik }}</p>

                                                       <div class="d-flex justify-content-end align-items-center mt-auto pt-2 border-top" style="border-color: #dee2e6 !important">
                                                            <small class="text-muted"><i class="bi bi-calendar-check me-1"></i>{{ pengumuman.timestamp.split(' ')[0] }}</small>
                                                       </div>
                                                  </div>
                                             </a>
                                        </div>
                                        {% endfor %}
                                   </div>
                              </div>
                              {% endfor %} {% if not paginated_pengumuman_list %}
                              <div class="carousel-item active">
                                   <div class="d-flex align-items-center justify-content-center py-5">
                                        <p class="text-muted">Belum ada pengumuman.</p>
                                   </div>
                              </div>
                              {% endif %}
                         </div>

                         <button class="carousel-control-prev" type="button" data-bs-target="#pengumumanCarousel" data-bs-slide="prev">
                              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Previous</span>
                         </button>
                         <button class="carousel-control-next" type="button" data-bs-target="#pengumumanCarousel" data-bs-slide="next">
                              <span class="carousel-control-next-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Next</span>
                         </button>
                    </div>
               </div>
          </div>
     </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
     document.addEventListener('DOMContentLoaded', function () {
         // Skema Warna untuk Marker Pop-up (Menyesuaikan dengan tema terang)
         const ACCENT_COLOR = '#1e88e5'; // Biru Cerah
         const DARK_BG_COLOR = '#343a40';

         // Inisialisasi map hanya jika elemen 'map' ada
         if (document.getElementById('map')) {
             var map = L.map('map').setView([-5.42, 105.26], 13); // Koordinat tengah Bandar Lampung
             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                 maxZoom: 19,
                 attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
             }).addTo(map);

             // Variabel ini harus disediakan oleh Flask di rute Anda
             const allLaporanData = {{ all_laporan_list | tojson | safe }};
             let markers = L.layerGroup().addTo(map);

             const statusColors = {
                 'Diterima': '#ffc107', // Kuning/Warning
                 'Diproses': '#1e88e5', // Biru Cerah
                 'Selesai': '#00897b'   // Hijau Teal
             };

             function createCustomIcon(status) {
                 const color = statusColors[status] || '#6c757d'; // Default Grey
                 return L.divIcon({
                     html: `<div style="width: 24px; height: 24px; background-color: ${color}; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.4); border: 2px solid white;"><i class="bi bi-geo-alt-fill" style="color: white; font-size: 12px;"></i></div>`,
                     className: 'custom-map-icon',
                     iconSize: [24, 24],
                     iconAnchor: [12, 24],
                     popupAnchor: [0, -24]
                 });
             }

             function updateMap(filter) {
                 markers.clearLayers();
                 allLaporanData.forEach(function(laporan) {
                     let show = false;
                     if (filter === 'semua') {
                         show = true;
                     } else if (filter === 'selesai' && laporan.status === 'Selesai') {
                         show = true;
                     } else if (filter === 'berjalan' && (laporan.status === 'Diterima' || laporan.status === 'Diproses')) {
                         show = true;
                     }

                     if (show && laporan.latitude && laporan.longitude) {
                         var marker = L.marker([laporan.latitude, laporan.longitude], {
                             icon: createCustomIcon(laporan.status)
                         });
                         marker.bindPopup(`<b>${laporan.judul}</b><br>Status: ${laporan.status}<br><a href="/laporan/${laporan.id}" style="color: ${ACCENT_COLOR};">Lihat Detail</a>`);
                         markers.addLayer(marker);
                     }
                 });
             }

             document.querySelectorAll('input[name="map_filter"]').forEach(radio => {
                 radio.addEventListener('change', function() {
                     updateMap(this.value);
                 });
             });

             // Initial map load
             updateMap('semua');
         }

         // Mengaktifkan fitur geser/swipe untuk carousel di perangkat mobile
         const carousels = document.querySelectorAll('.carousel.slide');
         carousels.forEach(carousel => {
             if (window.innerWidth < 768) {
                 new bootstrap.Carousel(carousel, {
                     interval: false
                 });
             }
         });

     });
</script>
{% endblock %}

{% extends "layout.html" %} {% block title %}Dashboard Publik Lapor!{% endblock %} {% block content %}
<div class="section" id="hero">
     <div class="container py-5 text-center">
          <h1 class="display-6 fw-bold text-white mb-3">Suara Anda, Perubahan Kota Kami</h1>
          <p class="lead text-white-50">Platform resmi Lapor! Pemerintah Kota Bandar Lampung. Laporkan berbagai isu mulai dari infrastruktur, layanan publik, hingga lingkungan, dan pantau langsung perkembangannya.</p>
          <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-4">
               <a href="{{ url_for('lapor') }}" class="btn btn-warning btn-lg px-4 gap-3 fw-bold laporan"> <i class="bi bi-chat-left-text-fill me-2"></i>Buat Laporan </a>
               <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-lg px-4"> <i class="bi bi-list-ul me-2"></i>Lihat Semua Laporan </a>
          </div>
     </div>

     <svg id="wave" style="transform: rotate(0deg); transition: 0.3s" viewBox="0 0 1440 100" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <defs>
               <linearGradient id="sw-gradient-0" x1="0" x2="0" y1="1" y2="0">
                    <stop stop-color="rgba(248, 249, 250, 1)" offset="0%"></stop>
                    <stop stop-color="rgba(248, 249, 250, 1)" offset="100%"></stop>
               </linearGradient>
          </defs>
          <path
               style="transform: translate(0, 0px); opacity: 1"
               fill="url(#sw-gradient-0)"
               d="M0,40L30,35C60,30,120,20,180,16.7C240,13,300,17,360,26.7C420,37,480,53,540,50C600,47,660,23,720,25C780,27,840,53,900,65C960,77,1020,73,1080,68.3C1140,63,1200,57,1260,51.7C1320,47,1380,43,1440,41.7C1500,40,1560,40,1620,41.7C1680,43,1740,47,1800,43.3C1860,40,1920,30,1980,36.7C2040,43,2100,67,2160,71.7C2220,77,2280,63,2340,48.3C2400,33,2460,17,2520,16.7C2580,17,2640,33,2700,33.3C2760,33,2820,17,2880,23.3C2940,30,3000,60,3060,60C3120,60,3180,30,3240,23.3C3300,17,3360,33,3420,40C3480,47,3540,43,3600,46.7C3660,50,3720,60,3780,66.7C3840,73,3900,77,3960,73.3C4020,70,4080,60,4140,48.3C4200,37,4260,23,4290,16.7L4320,10L4320,100L4290,100C4260,100,4200,100,4140,100C4080,100,4020,100,3960,100C3900,100,3840,100,3780,100C3720,100,3660,100,3600,100C3540,100,3480,100,3420,100C3360,100,3300,100,3240,100C3180,100,3120,100,3060,100C3000,100,2940,100,2880,100C2820,100,2760,100,2700,100C2640,100,2580,100,2520,100C2460,100,2400,100,2340,100C2280,100,2220,100,2160,100C2100,100,2040,100,1980,100C1920,100,1860,100,1800,100C1740,100,1680,100,1620,100C1560,100,1500,100,1440,100C1380,100,1320,100,1260,100C1200,100,1140,100,1080,100C1020,100,960,100,900,100C840,100,780,100,720,100C660,100,600,100,540,100C480,100,420,100,360,100C300,100,240,100,180,100C120,100,60,100,30,100L0,100Z"
          ></path>
     </svg>
</div>

<div class="section" id="peta">
     <div class="container-md text-center">
          <div class="row p-4 justify-content-around align-items-center">
               <div class="col-12 text-center mb-5">
                    <h4 class="display-6 fw-bold text-black">Laporan Terbaru</h4>
                    <p class="text-muted">Lihat laporan terbaru yang sudah masuk.</p>
               </div>

               <div class="col-12">
                    <div id="laporanCarousel" class="carousel slide" data-bs-ride="carousel">
                         <div class="carousel-inner" role="listbox">
                              {% set chunk_size = 4 %} {% set chunks = (paginated_laporan_list | batch(chunk_size)) %} {% for chunk in chunks %}
                              <div class="carousel-item {% if loop.first %}active{% endif %}">
                                   <div class="row g-4">
                                        {% for laporan in chunk %}
                                        <div class="col-lg-3 col-md-6">
                                             <a href="{{ url_for('detail_laporan', laporan_id=laporan.id) }}" class="card laporan-card shadow-sm h-100">
                                                  <div class="card-body d-flex flex-column">
                                                       <h5 class="card-title fw-bold text-truncate">{{ laporan.judul }}</h5>
                                                       <h6 class="card-subtitle mb-2 text-muted">Pelapor: {{ laporan.nama_pelapor }}</h6>
                                                       <p class="card-text flex-grow-1">{{ laporan.deskripsi }}</p>
                                                       <div class="d-flex justify-content-between align-items-center mt-auto pt-2">
                                                            <span
                                                                 class="badge {% if laporan.status == 'Diterima' %}bg-warning text-dark{% elif laporan.status == 'Diproses' %}bg-info text-dark{% elif laporan.status == 'Selesai' %}bg-success{% else %}bg-secondary{% endif %} rounded-pill"
                                                            >
                                                                 {{ laporan.status }}
                                                            </span>
                                                            <small class="text-muted">{{ laporan.timestamp.split(' ')[0] }}</small>
                                                       </div>
                                                  </div>
                                             </a>
                                        </div>
                                        {% endfor %}
                                   </div>
                              </div>
                              {% endfor %} {% if not paginated_laporan_list %}
                              <div class="carousel-item active">
                                   <div class="d-flex align-items-center justify-content-center py-5">
                                        <p class="text-muted">Belum ada laporan.</p>
                                   </div>
                              </div>
                              {% endif %}
                         </div>

                         <button class="carousel-control-prev" type="button" data-bs-target="#laporanCarousel" data-bs-slide="prev">
                              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Previous</span>
                         </button>
                         <button class="carousel-control-next" type="button" data-bs-target="#laporanCarousel" data-bs-slide="next">
                              <span class="carousel-control-next-icon" aria-hidden="true"></span>
                              <span class="visually-hidden">Next</span>
                         </button>
                    </div>
               </div>
          </div>
     </div>
</div>

<div class="section">
     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
          <path
               fill="#fff"
               fill-opacity="1"
               d="M0,160L34.3,165.3C68.6,171,137,181,206,186.7C274.3,192,343,192,411,181.3C480,171,549,149,617,138.7C685.7,128,754,128,823,160C891.4,192,960,256,1029,245.3C1097.1,235,1166,149,1234,138.7C1302.9,128,1371,192,1406,224L1440,256L1440,0L1405.7,0C1371.4,0,1303,0,1234,0C1165.7,0,1097,0,1029,0C960,0,891,0,823,0C754.3,0,686,0,617,0C548.6,0,480,0,411,0C342.9,0,274,0,206,0C137.1,0,69,0,34,0L0,0Z"
          ></path>
     </svg>
</div>
<div class="row g-4">
     <div class="col-lg-3 bg-pr">
          <h4 class="mb-3"><i class="bi bi-list-ul me-2"></i>Laporan Terbaru</h4>
          <div class="list-group shadow-sm listlaporan">
               {% for laporan in paginated_laporan_list %}
               <a href="{{ url_for('detail_laporan', laporan_id=laporan.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto">
                         <div class="fw-bold">{{ laporan.judul }}</div>
                         <small class="text-muted"><i class="bi bi-clock me-1"></i>{{ laporan.timestamp.split(' ')[0] }}</small>
                    </div>
                    <span
                         class="badge {% if laporan.status == 'Diterima' %}text-bg-warning {% elif laporan.status == 'Diproses' %}text-bg-primary {% elif laporan.status == 'Selesai' %}text-bg-success {% else %}text-bg-secondary {% endif %} rounded-pill"
                         style="font-size: 0.75rem"
                         >{{ laporan.status }}</span
                    >
               </a>
               {% else %}
               <div class="list-group-item text-center text-muted">Belum ada laporan.</div>
               {% endfor %}
          </div>

          {% if laporan_pagination.total_pages > 1 %}
          <nav class="mt-3">
               <ul class="pagination pagination-sm justify-content-center">
                    <li class="page-item {% if laporan_pagination.page == 1 %}disabled{% endif %}">
                         <a class="page-link" href="{{ url_for('index', laporan_page=laporan_pagination.page - 1, pengumuman_page=pengumuman_pagination.page) }}">&laquo;</a>
                    </li>
                    <li class="page-item active">
                         <span class="page-link">{{ laporan_pagination.page }} dari {{ laporan_pagination.total_pages }}</span>
                    </li>
                    <li class="page-item {% if laporan_pagination.page == laporan_pagination.total_pages %}disabled{% endif %}">
                         <a class="page-link" href="{{ url_for('index', laporan_page=laporan_pagination.page + 1, pengumuman_page=pengumuman_pagination.page) }}">&raquo;</a>
                    </li>
               </ul>
          </nav>
          {% endif %}
     </div>

     <div class="col-lg-6">
          <div class="card shadow-sm">
               <div class="card-header bg-white border-0 pt-3">
                    <div class="d-flex justify-content-between align-items-center">
                         <h5 class="mb-0 fw-bold"><i class="bi bi-map-fill me-2 text-primary"></i>Peta Sebaran Laporan</h5>
                         <div class="btn-group btn-group-sm" role="group">
                              <input type="radio" class="btn-check" name="map_filter" id="filter_semua" value="semua" checked />
                              <label class="btn btn-outline-primary" for="filter_semua">Semua</label>

                              <input type="radio" class="btn-check" name="map_filter" id="filter_berjalan" value="berjalan" />
                              <label class="btn btn-outline-primary" for="filter_berjalan">Berjalan</label>

                              <input type="radio" class="btn-check" name="map_filter" id="filter_selesai" value="selesai" />
                              <label class="btn btn-outline-primary" for="filter_selesai">Selesai</label>
                         </div>
                    </div>
               </div>
               <div class="card-body p-0">
                    <div id="map" style="height: 520px; border-radius: 0 0 0.375rem 0.375rem"></div>
               </div>
          </div>
     </div>

     <div class="col-lg-3">
          <h4 class="mb-3"><i class="bi bi-megaphone me-2"></i>Pengumuman</h4>
          <div class="list-group shadow-sm">
               {% for p in paginated_pengumuman_list %}
               <a href="{{ url_for('detail_laporan', laporan_id=p.id) }}" class="list-group-item list-group-item-action">
                    <div class="fw-bold">Re: {{ p.judul }}</div>
                    <p class="mb-1 small text-muted">"{{ p.pengumuman_publik|truncate(80) }}"</p>
                    <small class="text-muted"><i class="bi bi-calendar-check me-1"></i>{{ p.timestamp.split(' ')[0] }}</small>
               </a>
               {% else %}
               <div class="list-group-item text-center text-muted">Belum ada pengumuman.</div>
               {% endfor %}
          </div>

          {% if pengumuman_pagination.total_pages > 1 %}
          <nav class="mt-3">
               <ul class="pagination pagination-sm justify-content-center">
                    <li class="page-item {% if pengumuman_pagination.page == 1 %}disabled{% endif %}">
                         <a class="page-link" href="{{ url_for('index', laporan_page=laporan_pagination.page, pengumuman_page=pengumuman_pagination.page - 1) }}">&laquo;</a>
                    </li>
                    <li class="page-item active">
                         <span class="page-link">{{ pengumuman_pagination.page }} dari {{ pengumuman_pagination.total_pages }}</span>
                    </li>
                    <li class="page-item {% if pengumuman_pagination.page == pengumuman_pagination.total_pages %}disabled{% endif %}">
                         <a class="page-link" href="{{ url_for('index', laporan_page=laporan_pagination.page, pengumuman_page=pengumuman_pagination.page + 1) }}">&raquo;</a>
                    </li>
               </ul>
          </nav>
          {% endif %}
     </div>
</div>
{% endblock %} {% block scripts %} {{ super() }}
<script>
     document.addEventListener('DOMContentLoaded', function () {
         var map = L.map('map').setView([-5.42, 105.26], 13);
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             maxZoom: 19,
             attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
         }).addTo(map);

         const allLaporanData = {{ all_laporan_list | tojson | safe }};
         let markers = L.layerGroup().addTo(map);

         // Definisi warna yang konsisten dengan badge status
         const statusColors = {
             'Diterima': '#ffc107', // Kuning
             'Diproses': '#0d6efd', // Biru
             'Selesai': '#198754'   // Hijau
         };

         function createCustomIcon(status) {
             const color = statusColors[status] || '#6c757d'; // Default color abu-abu
             return L.divIcon({
                 html: `<div style="width: 24px; height: 24px; background-color: ${color}; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.4); border: 2px solid white;"><i class="bi bi-geo-alt-fill" style="color: white; font-size: 12px;"></i></div>`,
                 className: 'custom-map-icon',
                 iconSize: [24, 24],
                 iconAnchor: [12, 24],
                 popupAnchor: [0, -24]
             });
         }

         function updateMap(filter) {
             markers.clearLayers();
             allLaporanData.forEach(function(laporan) {
                 let show = false;
                 if (filter === 'semua') {
                     show = true;
                 } else if (filter === 'selesai' && laporan.status === 'Selesai') {
                     show = true;
                 } else if (filter === 'berjalan' && (laporan.status === 'Diterima' || laporan.status === 'Diproses')) {
                     show = true;
                 }

                 if (show && laporan.latitude && laporan.longitude) {
                     var marker = L.marker([laporan.latitude, laporan.longitude], {
                         icon: createCustomIcon(laporan.status)
                     });
                     marker.bindPopup(`<b>${laporan.judul}</b><br>Status: ${laporan.status}<br><a href="/laporan/${laporan.id}">Lihat Detail</a>`);
                     markers.addLayer(marker);
                 }
             });
         }

         document.querySelectorAll('input[name="map_filter"]').forEach(radio => {
             radio.addEventListener('change', function() {
                 updateMap(this.value);
             });
         });

         // Initial map load
         updateMap('semua');
     });
</script>
{% endblock %}
